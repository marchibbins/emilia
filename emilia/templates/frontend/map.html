{% extends 'base.html' %}

{% block content_class %}site-content--map{% endblock %}

{% block content %}
    <script type="text/javascript">
        var Emilia = Emilia || {};
        {% if books %}
            Emilia.books = {{ books|tojson }};
        {% endif %}
        {% if regions %}
            Emilia.regions = {{ regions|tojson }};
        {% endif %}
    </script>

    <div ng-app="emilia" ng-controller="emilia-map" ng-cloak>
        <div class="map-info">
            {% raw %}
                <div class="map-info__buttons">
                    <button ng-repeat="book in books" class="btn map-info__btn" ng-class="{'active': book.id === currentBook.id}" ng-click="selectBook(book.id)">Book {{ book.id }}</button>
                </div>

                <div class="book-info__pane" ng-if="currentBook.id && currentClimb === null">
                    <p class="book-info__loading" ng-if="currentBook.loading">Loading</p>
                    <ul class="unstyled" ng-if="currentBook.regions">
                        <li ng-repeat="region in currentBook.regions">
                            <h2><a class="book-info__region" href ng-click="selectRegion(region.id, true)" title="View climbs for {{ region.name }}" style="background-color: #{{ region.bg_colour }}; color: #{{ region.text_colour }}">{{ region.name }}</a></h2>
                            <ul class="book-info__climb-list unstyled" ng-if="region.climbs.length" ng-show="currentRegion.id === region.id">
                                <li ng-repeat="climb in region.climbs">
                                    <a class="book-info__climb" href ng-click="selectClimb(climb.id)" title="">{{ climb.number }}. {{ climb.name }}</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="climb-info__pane" ng-if="currentClimb.id">
                    <div class="climb-header" style="background-color: #{{ currentClimb.bg_colour }}; color: #{{ currentClimb.text_colour }}">
                        <h2 class="climb-header__name">{{ currentClimb.number }}. {{ currentClimb.name }}</h2>
                        <p class="climb-header__location">{{ currentClimb.location }}</p>
                        <ul class="climb-stats clearfix unstyled">
                            <li class="climb-stats__item">
                                <span class="climb-stats__label">Distance</span>
                                <span class="climb-stats__value">{{ currentClimb.segment.distance }}</span>
                            </li>
                            <li class="climb-stats__item">
                                <span class="climb-stats__label">Avg grade</span>
                                <span class="climb-stats__value">{{ currentClimb.segment.average_grade }}%</span>
                            </li>
                            <li class="climb-stats__item">
                                <span class="climb-stats__label">Max grade</span>
                                <span class="climb-stats__value">{{ currentClimb.segment.maximum_grade }}%</span>
                            </li>
                            <li class="climb-stats__item">
                                <span class="climb-stats__label">Height gain</span>
                                <span class="climb-stats__value">{{ currentClimb.segment.total_elevation_gain }}m</span>
                            </li>
                        </ul>
                    </div>

                    <div class="climb-info">
                        <div ng-if="currentClimb.club_leaders && showClubLeaders">
                            <h3>Club leaders</h3>
                            <ol ng-if="currentClimb.male_club_leaders">
                                <li ng-repeat="num in [1, 2, 3]" ng-init="entry = currentClimb.male_club_leaders.entries[$index]">
                                    <div ng-if="entry">{{ entry.athlete_name }}</div>
                                    <div ng-if="!entry">None</div>
                                </li>
                            </ol>
                            <ol ng-if="currentClimb.female_club_leaders">
                                <li ng-repeat="num in [1, 2, 3]" ng-init="entry = currentClimb.female_club_leaders.entries[$index]">
                                    <div ng-if="entry">{{ entry.athlete_name }}</div>
                                    <div ng-if="!entry">None</div>
                                </li>
                            </ol>
                            <a href ng-click="toggle('showClubLeaders')">Show overall leaders</a>
                        </div>

                        <div ng-if="currentClimb.leaders && !showClubLeaders">
                            <h3>Overall leaders</h3>
                            <ol ng-if="currentClimb.male_leaders">
                                <li ng-repeat="num in [1, 2, 3]" ng-init="entry = currentClimb.male_leaders.entries[$index]">
                                    <div ng-if="entry">{{ entry.athlete_name }}</div>
                                    <div ng-if="!entry">None</div>
                                </li>
                            </ol>
                            <ol ng-if="currentClimb.female_leaders">
                                <li ng-repeat="num in [1, 2, 3]" ng-init="entry = currentClimb.female_leaders.entries[$index]">
                                    <div ng-if="entry">{{ entry.athlete_name }}</div>
                                    <div ng-if="!entry">None</div>
                                </li>
                            </ol>
                            <a href ng-click="toggle('showClubLeaders')">Show club leaders</a>
                        </div>

                        <div ng-if="currentClimb.club_leaderboard && showClubLeaderboard">
                            <h3>Club standings</h3>
                            <ol ng-if="currentClimb.male_club_leaderboard">
                                <li ng-repeat="entry in currentClimb.male_club_leaderboard.entries">{{ entry.athlete_name }}</li>
                            </ol>
                            <ol ng-if="currentClimb.female_club_leaderboard">
                                <li ng-repeat="entry in currentClimb.female_club_leaderboard.entries">{{ entry.athlete_name }}</li>
                            </ol>
                            <a href ng-click="toggle('showClubLeaderboard')">Show overall standings</a>
                        </div>

                        <div ng-if="currentClimb.leaderboard && !showClubLeaderboard">
                            <h3>Overall standings</h3>
                            <ol ng-if="currentClimb.male_leaderboard">
                                <li ng-repeat="entry in currentClimb.male_leaderboard.entries">{{ entry.athlete_name }}</li>
                            </ol>
                            <ol ng-if="currentClimb.female_leaderboard">
                                <li ng-repeat="entry in currentClimb.female_leaderboard.entries">{{ entry.athlete_name }}</li>
                            </ol>
                            <a href ng-click="toggle('showClubLeaderboard')">Show club standings</a>
                        </div>

                        <a href ng-click="deselectClimb()">Back to regions</a>
                    </div>
                </div>
            {% endraw %}
        </div>

        {% raw %}
            <div class="map-container">
                <google-map center="map.center" control="map.control" draggable="{{ map.draggable }}" options="map.options" zoom="map.zoom">
                    <markers ng-if="currentRegion.climbs" models="currentRegion.climbs" coords="'coords'" click="clickMarker" fit="true" icon="'hiddenIcon'" options="{visible: false}" ng-show="false"></markers>
                    <markers ng-if="currentBook.markers" models="currentBook.markers" coords="'coords'" click="clickMarker" fit="true" icon="'icon'" labelAnchor="14 37" labelContent="'number'" labelClass="marker-label"></markers>
                    <!-- <polyline ng-if="currentClimb.polyline.visible" path="currentClimb.polyline.path" stroke="currentClimb.polyline.stroke"></polyline> -->
                </google-map>
            </div>
        {% endraw %}
    </div>

    <script src="http://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false"></script>
{% endblock %}